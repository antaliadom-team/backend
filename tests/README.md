![ci workflow](https://github.com/antaliadom-team/backend/actions/workflows/tests_deploy.yaml/badge.svg) [![codecov](https://codecov.io/github/antaliadom-team/backend/branch/dev/graph/badge.svg?token=IS5MLKDVWZ)](https://codecov.io/github/antaliadom-team/backend) ![Pytest](https://img.shields.io/badge/Pytest-7.2-blue) ![Pytest-mock](https://img.shields.io/badge/Pytest_Mock-3.10-blue)
# ✅ Тестирование

Проект покрыт тестами. Для запуска тестов, находясь в папке проекта,
выполните команду:

    $ pytest

Тесты выполняются в пайплайне на GitHub Actions при мерже в основные ветки
проекта и при деплое на тестовый / продакшн сервер.

Тесты состоят из следующих модулей:

      * `test_api.py` - тесты API
      * `test_jwt.py` - тесты токенов JWT
      * `test_models.py` - тесты моделей
      * `test_urls.py` - тесты доступа к страницам и ендпоинтам
      * `test_validators.py` - тесты валидаторов
      * `test_users.py` - тесты пользователей
      * `test_utils.py` - тесты вспомогательных функций

## Тесты API

Тесты API проверяют работу API приложения, а также соответствие передаваемых
эндпоинтам данных, сохраненным в базе данных.
Например,
```python
def test_favorite_object(self, user_client, favorite):
    """Test add object to favorites"""
```
Создает избранный объект для пользователя, проверяет, что нельзя добавить в
избранное несуществующий объект, а также, что нельзя добавить в избранное
объект, который уже находится в избранном.

Проверяет удаление объекта из избранного.

Для созданного объекта избранного проверяет поля пользователя и айди объекта.

Для эндпоинтов, которые работают только на чтение, проверяется соответствие
отдаваемой информации базе данных по каждому полю объекта.

```python
for key, value in expected_fields.items():
    assert response.data['results'][0][key] == value, (
        f'Значение поля {key} не совпадает, ожидалось {value}, '
        f'получено {response.data["results"][0][key]}'
    )
```

Для изображений проверяется, что эндпоинт возвращает изображение, хранящееся в
базе данных (id и url), а также количество изображений для каждого объекта.

## Тесты JWT

Проверяется создание и получение токена через ендпоинт `/api/auth/jwt/create/`
существующим пользователем, а также невозможность получения токена
пользователем с неправильным паролем, пользователем с неправильным
емейлом, а также пользователем, без пароля и емейла.

Проверяется валидация токена через ендпоинт `/api/auth/jwt/verify/`.

Проверяется невозможность валидации токена при передаче
неверного токена.

Проверяется возможность обновления токена через ендпоинт
`/api/auth/jwt/refresh/`, а также невозможность обновления токена при
передаче неверного токена.

## Тесты моделей

Проверяются все поля каждой модели на соответствие структуре проекта.

Проверяются ограничения на дублирование записей в базе данных.

```python
def test_favorite_constraints(self, favorite, object1, user):
    """Test model Favorite constraints"""
    with pytest.raises(IntegrityError):
        Favorite.objects.create(real_estate=object1, user=user)
```
Проверяются verbose_names, содержание __str__ методов моделей.

## Тесты доступа к страницам

Проверяются коды доступа к страницам, которые должны быть доступны только
для авторизованных пользователей.

Дополнительно проверяются принудительно отключенные эндпоинты.

## Тесты валидаторов

Проверяется валидация полей и работа валидаторов телефона, имени и фамилии.

## Тесты юзеров

Проверяется создание пользователя через ендпоинт `/api/users/`.
Проверяется валидация полей пароля, емейла, имени, телефона.

Проверяется успешное создание пользователя в базе данных и соответствие
полям в базе данных.
Для этого из базы принудительно удаляются все записи пользователей.
Делается обращение к ендпоинту создания пользователя и проверяется количество
созданных юзеров и соответствие полей в базе данных:
```python
assert User.objects.count() == 1, 'Пользователь не создан'
assert User.objects.first().email == data['email'], 'Неверный email'
assert (
    User.objects.first().first_name == data['first_name']
), 'Неверное имя'
assert (
    User.objects.first().last_name == data['last_name']
), 'Неверная фамилия'
assert User.objects.first().phone == data['phone'], 'Неверный телефон'
assert User.objects.first().check_password(
    data['password']
), 'Неверный пароль'
assert (
    User.objects.first().agreement == data['agreement']
), 'Неверное соглашение, должно быть True'
```

Проверяется невозможность создания пользователя без емейла, с разными
паролями и проверочным паролем, без принятого пользовательского соглашения.

Дополнительно осуществляется проверка создания суперпользователя, а также
что обычный пользователь не обладает правами суперпользователя.

Осуществляется тест ендпоинта для логаута юзера.

## Тесты вспомогательных функций

Тестируется работа отправки почты через ендпоинт `/api/objects/order`
анонимным и авторизованным пользователем.
